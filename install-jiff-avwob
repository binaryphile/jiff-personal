#!/usr/bin/env bash

declare -r InstallDir=/opt/app/avwobt4
declare -r RepoUri=bertrand:tmp
declare -r GitVersion=2.7.4
declare -r GitDir="git-${GitVersion}"
declare -r Filename="${GitDir}-static-avwobt4.tar.gz"

main () {
  [[ -d "InstallDir" ]] || exit 1
  which git 2>/dev/null || install_git
  install_basher
  install_jiff
  success_message
}

install_basher () {
  push_dir "/opt/app"
  git clone git@github.com/basherpm/basher avwobt4
  cd avwobt4/libexec
  sed -i -e 's|${bin_path}:${PATH}|${PATH}:${bin_path}|' basher
  sed -i -e 's|$BASHER_ROOT/cellar/bin:$PATH|$PATH:$BASHER_ROOT/cellar/bin|' -e 's|$BASHER_ROOT/cellar/bin $PATH|$PATH $BASHER_ROOT/cellar/bin|' basher-init
  sed -i -e 's|https://github.com/|git@github.com:|' -e 's|--depth=1||' basher-_clone
  pop_dir
}

install_git () {
  cd "${InstallDir}"
  scp "${RepoUri}/${Filename}" .
  tar xzf "${Filename}"
  rm "${Filename}"
}

install_jiff () {
  export BASHER_ROOT="${InstallDir}"
  "${InstallDir}/bin/basher" install binaryphile/jiff-personal
}

pop_dir () {
  popd >/dev/null
}

push_dir () {
  pushd "$1" >/dev/null
}

success_message () {
  cat <<EOM

Note: If you are using bash as your shell, run "exec bash" to load jiff
onto your path.  Otherwise follow the basher instructions for loading
basher into your shell's environment then source those files or
re-login.

You'll also want to run "jiff set context" to set your context.
EOM
}

return 0 2>/dev/null || true
set -o errexit
set -o nounset
set -o pipefail
main "$@"
